# Week 19 Note

本周课程介绍了如何搭建一个 `简易` 的发布系统，系统由：应用部署服务器（Express），发布服务器，发布工具三个部分构成。

## Application Server

课程主要使用 `Express` Generator 生成的代码模板简化后形成，主要利用了 `statc` 中间件对静态文件进行 `host`。没有用到其他更多的功能。

## Publish Server

主要用于发布命令行工具与应用部署服务器之间的桥梁，负责鉴权，接收发布压缩包，将压缩包解压到应用服务器对应目录的工作。

## Publish Tool

CLI 工具，将指定目录进行打包并通过接口上传至开发服务器。在后续的改造过程中添加了 `Github OAuth` 的集成，会在每次发布时候拉起浏览器并通过 Publish Server 与 Github Server 进行用户鉴权对接，成功后执行发布动作。

## 总结

从本周课程和我个人的经验来看，发布系统主要有几个核心部分组成：

- 生成发布包

    发布包有很多种形式，本课程中的静态文件压缩包是其中一种。对于一些复杂的带有操作系统其他环境依赖的项目来看，打包生成容器镜像是一种更适合的选择。但是这也需要额外 Image Registry Service 的支持。

- 上传发布包

    本周项目中借助 Http 接口作为上传发布包的管道，在实现的过程中也利用到了 Stream 这一 NodeJs 中的概念，这样做的好处是可以完全不用通过文件系统 IO 而直接在内存中对发布包进行生成和传递，在高频使用场景下性能比生成临时发布文件更好，也不用额外的定期清理临时打包文件的问题。如果是在没有 GUI 界面的 Linux 系统上使用，可能需要使用 Headless Browser 来代替打开图形化浏览器对应的操作。

- 部署发布包

    课程中使用了 Express 的 static 来部署静态文件，当 statc 配置对应的目录中文件进行更新时，由于默认不启用缓存策略，每次静态文件请求都会重新读取磁盘文件，这样做可以做到静态文件的实时更新。但是如果服务器配置了 Express static 的缓存策略后，可能更新不能立即反应到下一次新的请求上，这时候就要在部署服务器上考虑静态文件缓存策略。缓存策略有很多种，在编译时的文件名 + hash 的方式是其中一种。而对于 `html` 文件本身可以考虑不设置缓存。

总的来说本周课程结束以后，一个简单清晰的发布系统结构已经很好地被阐释了，并且也在这其中重温了 OAuth 的对接以及 Stream Api 的使用。