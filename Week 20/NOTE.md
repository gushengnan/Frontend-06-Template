# Week 20 Note

本周是课程的最后一周，主要内容涵盖了 `git hooks` 的编写（主要是 `pre-commit hook`）与 `eslint` 检测的结合。最后介绍了 `headless chrome` 技术以及如何使用 `puppeteer` 来编写代码操作无头浏览器执行相应动作。

## 软件开发的持续集成

一般软件产品开发流程中会设定一些用于日常检测的自动化任务，用来提早发现开发中软件的问题并及时修复，其中又分为编译时与运行时的验证任务，它们分别为：

- Daily Build

    主要验证软件能否通过编译器的检测成功编译。

- Build Verification Test (BVT)

    运行时基本验证，用于发现编译时无法发现的问题。

> 无论软件架构如何，基本主要都是在编译时发现问题。但是，运行时问题是没有办法在编译时发现的。比如：在前后端联调时，如果服务端不遵守接口约定会导致 Daily Build 环境上的系统出错，但是问题出在服务端，需要在运行时才能够发现（如果服务端没有针对接口约定的单元测试）。

### C/S 架构客户端开发

开发周期长，有足够时间编写 e2e 测试用例，一般由测试人员编写。

### B/S 架构客户端开发

利用无头浏览器做一些轻量级的 e2e 测试。

### 前端的现状

由于前端软件的编译时间短的特性（分钟级），基本会搭配以 80% 左右覆盖率的单元测试及简单的 e2e 测试的方式提供轻量级的 `BVT` 方案，少部分重量级 Web 产品除外。

## git hooks

git hooks 提供给了用户可以在 git 命令执行的不同时刻执行定制化脚本的能力。一般前端工程化中比较常用的钩子有 `pre-commit` & `pre-push`。用于限制用户在提交前执行必要的检测。但是这些钩子的执行是可以通过 git 命令来跳过的，所以基于 git hooks 的工程化限制手段是 `防君子不防小人`。

### eslint 与 git hook 的集成

git hooks 的实现方式是执行自定义脚本，脚本并不限制使用的脚本语言，可以是 `shell` 脚本亦或是 `javascript` 脚本，但是基于 `shell` 脚本的规范（或者 unix 系列系统脚本的规范），需要在脚本头部首行以注释的方式指定执行脚本的运行环境及应用，下面是一个指定使用 `node` 作为脚本执行程序的例子。

```shell
#!/usr/bin/env node
## 对应的 javascript 脚本代码，执行环境中需要有 nodejs 安装
```

## Headless Chrome & Puppeteer

无头 `Chrome` 浏览器是一种不需要 GUI 运行环境也运行 Chrome 浏览器的技术，它提出了一套 API 规范来通过命令而不是鼠标点击的方式来操作浏览器，具有浏览器的绝大部分能力。

而 `Puppeteer` 是基于这套 API 的上层 JavaScript API 封装，执行于 Nodejs 环境，用于使用 JavaScript 代码来控制无头浏览器的行为，一般用于爬虫或者是端到端的测试。

> Windows WSL Alias 指向
> ```shell
> # Window 下路径也类似
> alias chrome="/mnt/c/Program\ Files\ \(x86\)/Google/Chrome/Applicationchrome.exe"
> # 但是日志输出有问题，还是建议直接在 Windows 下直接运行
> ```

## 总结

对于 Git Hooks 与 Eslint 结合的部分其实在实际工作中已经有比较成熟的落地实践，也是我自己在团队内正在推广的，当然大部分都是由 husky 提供的 pre-commit 能力，对 staged 代码在提交前进行 lint。

对于 Puppeteer 的使用，我在搜索了一些资料后通过简单的编码就可以实现对我工作中的某个业务系统进行登录截图操作，用来验证登录流程是否能够执行成功。但是在编写的时候发现如果通过编码的方式还是效率比较低的，后来搜索以后发现有浏览器插件能够进行执行动作的 `录制` 并导出基于 Puppeteer 风格的代码，可以直接执行。基于此，我认为实际在较成熟的公司内部一定会有类似测试脚本录制的平台用于录制端到端的测试脚本并提供回放能力。这样效率更高也更具有可执行性。

我也尝试了在 WSL 环境下调用宿主 Windows 操作系统上的 Headless Chrome，也不是很好用，不显示日志输出。

总的来说，经过这一周的学习我也学习到了一个新的名词叫做 Build Verification Test (BVT)，用于指代运行时轻量级测试的一个统称，那么这个对应到前端里应当就是一些基础能力的测试，比如系统运行后是否可以登录，一些框架的基础业务是否运行正常等。属于端到端测试的范畴。另外，对于在 shell 脚本头部指定运行环境和执行应用也有了更深的认识。





